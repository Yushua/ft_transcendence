<!DOCTYPE html>
<html>
<body onload="onload()">
<script> function onload() {
	updateUsers()
} </script>

<h1>Chat App</h1>

<script>
	LOG_SIG = !true
	LOG_HTTP = !true
	
	function UserID() { return document.getElementById("UserID").value }
	function RoomID() { return document.getElementById("RoomID").value }
	var Room
	var User
	var ChatUser
	async function downloadRoom()     { Room     = await GET_OBJ(`chat/room/${RoomID()}`) }
	async function downloadChatUser() { ChatUser = await GET_OBJ(`chat/user/${UserID()}`) }
	async function downloadUser()     { User     = await GET_OBJ(`user-profile/user/${UserID()}`) }
	_isAdmin = false
	function IsAdmin() { return _isAdmin }
</script>

<!-- Events -->
<script>
	var userEvent = null
	async function SubscribeToUserEvent() {
		try {
			userEvent.close()
			userEvent = null
		} catch (error) {}
		userEvent = new EventSource(`/chat/event/user-${UserID()}`)
		userEvent.onmessage = msg => {
			if (LOG_SIG)
				console.log(`msg: ${msg.data}`)
			switch (msg.data) {
				case "you have been added":
					updateUsers()
					break;
				default:
					break;
			}
		}
	}
	
	var roomEvent = null
	function SubscribeToRoomEvent() {
		try {
			roomEvent.close()
			roomEvent = null
		} catch (error) {}
		roomEvent = new EventSource(`/chat/event/room-${RoomID()}`)
		roomEvent.onmessage = async msg => {
			if (LOG_SIG)
				console.log(`msg: ${msg.data}`)
			switch (msg.data) {
				case "room":
					updateRooms()
					break
				case "mem":
					await downloadRoom()
					updateMembers()
					break
				case "msg":
					updateChat()
					break
				default: break
			}
		}
	}
</script>

<div id="DivUserSelect">
	User select: <select name="UserID" id="UserID" onchange="changeUser()"> </select><br>
	<br>
	<script>
		async function updateUsers() {
			const users = await GET_OBJ("user-profile/user")
			var options = ""
			for (const user of users)
				options += `<option value="${user.id}">${user.username}</option><br>`
			document.getElementById("UserID").innerHTML = options
			changeUser()
		}
		
		async function changeUser() {
			if (UserID() == "") {
				document.getElementById("DivNewRoom").style.display = "none"
				return
			}
			document.getElementById("DivNewRoom").style.display = "block"
			
			await downloadUser()
			await downloadChatUser()
			SubscribeToUserEvent()
			
			updateRooms()
		}
	</script>
</div>

<div id="DivNewRoom">
	Room Password: <input type="text" id="RoomPassword" name="RoomPassword">
	Private: <input type="checkbox" id="Private" name="Private"><br>
	<button type="button" onclick="newRoom()">Make New Room</button><br>
	<br>
	<script>
		async function newRoom() {
			const user = document.getElementById("UserID").value
			const pass = document.getElementById("RoomPassword").value
			const priv = document.getElementById("Private").value
			if (!!await POST(`chat/room`, {OwnerID: user, Password:pass, RoomType:(priv?"Private":"Public") }))
				updateRooms()
		}
	</script>
</div>

<div id="DivRoomSelect">
	Room select: <select name="RoomID" id="RoomID" onchange="roomChange()"> </select><br>
	<br>
	<script>
		async function updateRooms() {
			var options = ""
			for (const roomID of this.ChatUser.ChatRoomsIn)
				options += `<option value="${roomID}">${roomID}</option><br>`
			document.getElementById("RoomID").innerHTML = options
			roomChange()
		}
		
		async function roomChange() {
			
			const roomStyle = (RoomID() != "") ? "block" : "none"
			document.getElementById("DivRoomSelect").style.display = roomStyle
			document.getElementById("DivChatWindow").style.display = roomStyle
			if (roomStyle === "none")
				return
			
			await downloadRoom()
			SubscribeToRoomEvent()
			
			updateMembers()
			
			updateChat()
		}
		
	</script>
</div>

<div id="DivChatWindow" style="overflow:hidden">
	<div id="DivAddFriend">
		<div id="FriendList"></div>
		<script>
			async function updateFriends() {
				friendList = ""
				for (const friendID of User.friendList) {
					
					friendList += `${await getUserName(friendID)}`
					if (!Room.MemberIDs.includes(friendID)) {
						if (Room.BanIDs.includes(friendID))
							friendList += ` [Banned in this room]`
						else
							friendList += ` <button onclick="aPOST('chat/room/${RoomID()}/${friendID}')">Add To Room</button>`
					}
					friendList += "<br>"
				}
				if (friendList != "")
					friendList = "-~={ Friend List }=~-<br>" + friendList + "<br>"
				document.getElementById("FriendList").innerHTML = friendList
			}
		</script>
	</div>
	
	<div id="DivChatLog" style="float:left">
		
		<!-- Message Log -->
		<div id="chat">1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>A<br></div><script>
			const LogDepth = 10
			async function updateChat() {
				
				document.getElementById("chat").innerHTML = "";
				
				var count = 0
				var chat = ""
				
				for (let page = 1; count < LogDepth; page++) {
					const msgs = await GET_OBJ(`chat/msg/${RoomID()}/-${page}`)
					
					if (msgs.length == 0)
						break
					
					for (let i = msgs.length - 1; count < LogDepth && i >= 0; i--) {
						count++
						chat = `${await getUserName(msgs[i].OwnerID)}: ${msgs[i].Message}<br>` + chat
					}
				}
				
				for (; count < 10; count++)
					chat = `<br>` + chat
				document.getElementById("chat").innerHTML = chat;
			}
		</script>
		
		<!-- Send Message -->
		<input type="text" id="MessageBox" name="MessageBox" onkeydown="sendMessage()"> <script>
			function sendMessage() {
				if (event.key !== "Enter")
					return
				const msgBox = document.getElementById("MessageBox")
				aPOST(`chat/msg/${RoomID()}`, { OwnerID: UserID(), Message: msgBox.value})
				msgBox.value = ""
			}
		</script>
	</div>
	
	<div id="DivMembersList" style="overflow:hidden">
		<div id="ChatMebersList"></div>
		<script>
			async function updateMembers() {
				updateFriends()
				const members = Room.MemberIDs
				const admins = Room.AdminIDs
				const ownerID = Room.OwnerID
				memberList = ""
				for (const memberID of members) {
					// if (member === UserID())
					// 	continue
					memberList += `${await getUserName(memberID)} `
					if (!admins.includes(memberID)) {
						if (admins.includes(UserID()))
							memberList += `<button>Mute</button>`
								+ `<button onclick="DELETE('chat/member/${RoomID()}/${memberID}')">Kick</button>`
								+ `<button onclick="DELETE('chat/ban/${RoomID()}/${memberID}')">Ban</button>`
								+ `<button onclick="aPOST('chat/admin/${RoomID()}/${memberID}')">Make Admin</button>`
					}
					else {
						if (UserID() == ownerID)
							memberList += (memberID == ownerID) ? "[Owner]" : `[Admin] <button onclick="DELETE('chat/admin/${Room.ID}/${memberID}')">De-Admin</button>`
						else
							memberList += (memberID == ownerID) ? "[Owner]" : "[Admin]"
					}
					memberList += "<br>"
				}
				document.getElementById("ChatMebersList").innerHTML = memberList
			}
		</script>
	</div>
</div>

<button type="button" onclick="deleteALL()">[DEBGU] Delete all chat data</button>
<script> function deleteALL() { DELETE("chat/all"); setTimeout(onload, 100) }</script>

<div id="debug"></div>

<script id="LocalUsernameStorage">
	var users = {}
	async function getUserName(userID) {
		if (userID in users)
			return users[userID]
		const user = await GET_OBJ(`user-profile/user/${userID}`)
		users[userID] = user.username
		return user.username
	}
</script>

<script id="HTTP">

	function GET(url, hdr = null) {
		if (LOG_HTTP)
			console.log(`GET ${url}`)
		var req = new XMLHttpRequest();
		req.open("GET", url, false);
		if (!!hdr)
			for (const header of Object.entries(hdr))
				req.setRequestHeader(header[0], header[1])
		req.send();
		if (req.status === 200)
			return req.responseText
		console.log(req.responseText)
		return null
	}
	
	async function GET_OBJ(url, hdr = null) {
		const res = GET(url, hdr)
		try {
			return JSON.parse(res)
		} catch (error) {
			console.log(`${res} - ${error}`)
			return res
		}
	}
	
	function aPOST(url, obj = "", hdr = null) {
		if (LOG_HTTP)
			console.log(`POST ${url}`)
		var req = new XMLHttpRequest();
		req.open("POST", url);
		if (!!hdr)
			for (const header of Object.entries(hdr))
				req.setRequestHeader(header[0], header[1])
		if (typeof obj == "object") {
			req.setRequestHeader("content-type", "application/x-www-form-urlencoded")
			var body = ""
			for (const entry of Object.entries(obj))
				body += `${entry[0]}=${entry[1]}&`
			req.send(body);
		}
		else
			req.send(obj);
	}
	
	function POST(url, obj = "", hdr = null) {
		if (LOG_HTTP)
			console.log(`POST ${url}`)
		var req = new XMLHttpRequest();
		req.open("POST", url, false);
		if (!!hdr)
			for (const header of Object.entries(hdr))
				req.setRequestHeader(header[0], header[1])
		if (typeof obj == "object") {
			req.setRequestHeader("content-type", "application/x-www-form-urlencoded")
			var body = ""
			for (const entry of Object.entries(obj))
				body += `${entry[0]}=${entry[1]}&`
			req.send(body);
		}
		else
			req.send(obj);
		if (req.status === 201)
			return req.responseText
		console.log(req.responseText)
		return null
	}
	
	async function POST_OBJ(url, obj = "", hdr = null) {
		const res = POST(url, obj, hdr)
		try {
			return JSON.parse(res)
		} catch (error) {
			console.log(error)
			return res
		}
	}
	
	async function DELETE(url) {
		if (LOG_HTTP)
			console.log(`DELETE ${url}`)
		var req = new XMLHttpRequest();
		req.open("DELETE", url);
		req.send();
	}
</script>

</body>
</html>
