<!DOCTYPE html>
<html>
<body onload="onload()">
<script> function onload() { updateUsers() } </script>

<h1>Chat App</h1>

<div id="DivUserSelect">
	User select: <select name="UserID" id="UserID" onchange="changeUsers()"> </select><br>
	<br>
	<script>
		async function updateUsers() {
			const users = await GET_OBJ("user-profile/user")
			var options = ""
			for (const user of users)
				options += `<option value="${user.id}">${user.username}</option><br>`
			document.getElementById("UserID").innerHTML = options
			changeUsers()
		}
		
		async function changeUsers() {
			const userID = document.getElementById("UserID").value
			const roomStyle = (userID != "") ? "block" : "none"
			document.getElementById("DivNewRoom").style.display = roomStyle
			updateRooms()
			
			closeUserEvent()
			if (userID == "")
				return
			const roomID = document.getElementById("RoomID").value
			userEvent = new EventSource(`/chat/event/user-${userID}`)
			userEvent.onmessage = msg => {
				switch (msg.data) {
					case "you have been added":
						changeUsers()
						break;
					default:
						break;
				}
			}
		}
		
		var userEvent = null
		function closeUserEvent() {
			try {
				userEvent.close()
				userEvent = null
			} catch (error) {}
		}
	</script>
</div>

<div id="DivNewRoom">
	Room Password: <input type="text" id="RoomPassword" name="RoomPassword">
	Private: <input type="checkbox" id="Private" name="Private"><br>
	<button type="button" onclick="newRoom()">Make New Room</button><br>
	<br>
	<script>
		async function newRoom() {
			const user = document.getElementById("UserID").value
			const pass = document.getElementById("RoomPassword").value
			const priv = document.getElementById("Private").value
			if (!!await POST(`chat/room`, {OwnerID: user, Password:pass, RoomType:(priv?"Private":"Public") }))
				updateRooms()
		}
	</script>
</div>

<div id="DivRoomSelect">
	Room select: <select name="RoomID" id="RoomID" onchange="roomChange()"> </select><br>
	<br>
	<script>
		async function updateRooms() {
			const userID = document.getElementById("UserID").value
			const roomIDs = await GET_OBJ(`chat/user/${userID}/ChatRoomsIn`)
			var options = ""
			for (const roomID of roomIDs)
				options += `<option value="${roomID}">${roomID}</option><br>`
			document.getElementById("RoomID").innerHTML = options
			roomChange()
		}
		
		async function roomChange() {
			
			closeRoomEvent()
			
			const userID = document.getElementById("UserID").value
			const roomID = document.getElementById("RoomID").value
			
			if (roomID != "") {
				const adminIDs = await GET_OBJ(`chat/room/${roomID}/AdminIDs`)
				document.getElementById("DivAdminOptions").style.display
					= (adminIDs.includes(userID)) ? "block" : "none"
				const ownerID = GET(`chat/room/${roomID}/OwnerID`)
				document.getElementById("DivOwnerOptions").style.display
					= (ownerID == userID) ? "block" : "none"
			}
			else {
				document.getElementById("DivAdminOptions").style.display
					= "none"
				document.getElementById("DivOwnerOptions").style.display
					= "none"
			}
			
			const roomStyle = (roomID != "") ? "block" : "none"
			document.getElementById("DivRoomSelect").style.display = roomStyle
			document.getElementById("DivChatLog").style.display = roomStyle
			if (roomStyle === "none")
				return
			
			updateMembers()
			
			closeRoomEvent()
			roomEvent = new EventSource(`/chat/event/room-${roomID}`)
			roomEvent.onmessage = msg => {
				switch (msg.data) {
					case "room": updateRooms();
					case "mem": updateMembers(); break;
					case "msg": updateChat(); break;
					default: break;
				}
			}
			
			updateChat()
		}
		
		var roomEvent = null
		function closeRoomEvent() {
			try {
				roomEvent.close()
				roomEvent = null
			} catch (error) {}
		}
	</script>
</div>

<div id="DivOwnerOptions">
	-~={ Owner options }=~-<br>
	<input type="text" name="" id="">
		<button type="button" onclick="changePassword()">Change Password</button><br>
	<select name="AdminIDs" id="AdminIDs"></select>
		<button type="button" onclick="removeAdmin()">Remove Admin</button><br>
	<button type="button" onclick="deleteRoom()">Delete Room</button><br>
	<br>
</div>

<div id="DivAdminOptions">
	-~={ Admin options }=~-<br>
	<select name="AddMemberID" id="AddMemberID"> </select>
		<button type="button" onclick="addMember()">Add User</button>
	<br>
	<select name="ModMemberID" id="ModMemberID"> </select>
		<button type="button" onclick="removeMember()">Kick User</button>
		<button type="button" onclick="banMember()">Ban User</button>
		<button type="button" onclick="makeAdmin()">Make Admin</button><br>
		<button type="button" onclick="muteMember()">Mute User for </button> <input type="text" name="" id=""> seconds.
	<br>
	<script>
		async function updateMembers() {
			// Current members
			const roomID = document.getElementById("RoomID").value
			const members = await GET_OBJ(`chat/room/${roomID}/MemberIDs`)
			options = ""
			for (const member of members)
				options += `<option value="${member}">${await getUserName(member)}</option><br>`
			document.getElementById("ModMemberID").innerHTML = options
			
			// Add members
			const userID = document.getElementById("UserID").value
			const users = await GET_OBJ("user-profile/user")
			var options = ""
			for (const user of users)
				if (user.id != userID && !members.includes(user.id))
					options += `<option value="${user.id}">${user.username}</option><br>`
			document.getElementById("AddMemberID").innerHTML = options
		}
		
		async function makeAdmin() {
			const memID = document.getElementById("ModMemberID").value
			const roomID = document.getElementById("RoomID").value
			if (memID == "" || roomID == "")
				return
			POST(`chat/admin/${roomID}/${memID}`)
		}
		
		async function addMember() {
			const memID = document.getElementById("AddMemberID").value
			const roomID = document.getElementById("RoomID").value
			if (memID == "" || roomID == "")
				return
			POST(`chat/room/${roomID}/${memID}`)
		}
		
		async function removeMember() {
			const memID = document.getElementById("ModMemberID").value
			const roomID = document.getElementById("RoomID").value
			if (memID == "" || roomID == "")
				return
			DELETE(`chat/member/${roomID}/${memID}`)
		}
	</script>
</div>

<div id="DivChatLog">
	<div id="chat"></div>
	<input type="text" id="MessageBox" name="MessageBox" onkeydown="sendMessageEnter()">
	<button type="button" onclick="sendMessage()">Send</button><br>
	<br>
	<script>
		function sendMessageEnter() {
			if (event.key === "Enter")
				sendMessage()
		}
		
		function sendMessage() {
			
			const userID = document.getElementById("UserID").value
			const roomID = document.getElementById("RoomID").value
			const msgBox = document.getElementById("MessageBox")
			POST(`chat/msg/${roomID}`, { OwnerID: userID, Message: msgBox.value})
			msgBox.value = ""
		}
		
		const LogDepth = 10
		async function updateChat() {
			
			document.getElementById("chat").innerHTML = "";
			
			const room = document.getElementById("RoomID").value
			
			var count = 0
			var chat = ""
			
			for (let page = 1; count < LogDepth; page++) {
				const msgs = await GET_OBJ(`chat/msg/${room}/-${page}`)
				
				if (msgs.length == 0)
					break
				
				for (let i = msgs.length - 1; count < LogDepth && i >= 0; i--) {
					count++
					chat = `${await getUserName(msgs[i].OwnerID)}: ${msgs[i].Message}<br>` + chat
				}
			}
			
			for (; count < 10; count++)
				chat = `<br>` + chat
			document.getElementById("chat").innerHTML = chat;
		}
	</script>
</div>

<button type="button" onclick="deleteALL()">[DEBGU] Delete all chat data</button>
<script> function deleteALL() { DELETE("chat/all"); setTimeout(onload, 100) }</script>

<div id="debug"></div>

<script id="LocalUsernameStorage">
	var users = {}
	async function getUserName(userID) {
		if (userID in users)
			return users[userID]
		const user = await GET_OBJ(`user-profile/user/${userID}`)
		users[userID] = user.username
		return user.username
	}
</script>

<script id="HTTP">

	function GET(url, hdr = null) {
		// console.log(`GET ${url}`)
		var req = new XMLHttpRequest();
		req.open("GET", url, false);
		if (!!hdr)
			for (const header of Object.entries(hdr))
				req.setRequestHeader(header[0], header[1])
		req.send();
		if (req.status === 200)
			return req.responseText
		document.getElementById("debug").innerHTML = req.responseText
		return null
	}
	
	async function GET_OBJ(url, hdr = null) {
		const res = GET(url, hdr)
		try {
			return JSON.parse(res)
		} catch (error) {
			console.log(`${res} - ${error}`)
			return res
		}
	}
	
	function POST(url, obj = "", hdr = null) {
		// console.log(`POST ${url}`)
		var req = new XMLHttpRequest();
		req.open("POST", url, false);
		if (!!hdr)
			for (const header of Object.entries(hdr))
				req.setRequestHeader(header[0], header[1])
		if (typeof obj == "object") {
			req.setRequestHeader("content-type", "application/x-www-form-urlencoded")
			var body = ""
			for (const entry of Object.entries(obj))
				body += `${entry[0]}=${entry[1]}&`
			req.send(body);
		}
		else
			req.send(obj);
		if (req.status === 201)
			return req.responseText
		document.getElementById("debug").innerHTML = req.responseText
		return null
	}
	
	async function POST_OBJ(url, obj = "", hdr = null) {
		const res = POST(url, obj, hdr)
		try {
			return JSON.parse(res)
		} catch (error) {
			console.log(error)
			return res
		}
	}
	
	async function DELETE(url) {
		var req = new XMLHttpRequest();
		req.open("DELETE", url);
		req.send();
	}
</script>

</body>
</html>
